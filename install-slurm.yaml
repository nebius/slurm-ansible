- name: Install slurm
  hosts: all
  become: yes
  become_user: root
  tasks:
    - name: Install munge and dependencies
      ansible.builtin.apt:
        pkg:
          - munge
          - build-essential
          - git
          - mariadb-server
          - wget
          - vim
        update_cache: yes
      
    - name: Install slurm
      ansible.builtin.apt:
        pkg:
          - slurmd
          - slurm-client
      
      
    - name: Copy cgroups config
      ansible.builtin.copy:
        src: files/cgroup.conf
        dest: /etc/slurm-llnl/cgroup.conf

    - name: copy slurm config
      ansible.builtin.copy:
        src: files/slurm.conf
        dest: /etc/slurm-llnl/slurm.conf
      
    - name: Update CPU configuration
      ansible.builtin.shell: sudo sed -i "s/REPLACE_IT/CPUs=$(nproc)/g" /etc/slurm-llnl/slurm.conf
      

    - name: Make sure a service unit is running
      ansible.builtin.systemd:
        state: stopped
        name: munge

- name: Run master
  hosts: master
  become: yes
  become_user: root

  tasks:
    - name: Instal slurm for master
      ansible.builtin.apt:
        pkg:
          - slurmctld

    - name: Make sure a service unit is running
      ansible.builtin.systemd:
        state: stopped
        name: slurmctld

    - name: Fetch munge key
      ansible.builtin.fetch:
        src: /etc/munge/munge.key
        dest: files/munge.key
        flat: yes

    - name: Make sure a service unit is running
      ansible.builtin.systemd:
        state: started
        name: munge

    - name: Make sure a service unit is running
      ansible.builtin.systemd:
        state: started
        name: slurmctld


- name: Run nodes
  hosts: nodes
  become: yes
  become_user: root
  tasks:
    - name: Make sure a service unit is running
      ansible.builtin.systemd:
        state: stopped
        name: slurmd

    - name: copy munge.key config
      ansible.builtin.copy:
        src: files/munge.key
        dest: /etc/munge/munge.key

    - name: Make sure a service unit is running
      ansible.builtin.systemd:
        state: started
        name: munge

    - name: Make sure a service unit is running
      ansible.builtin.systemd:
        state: started
        name: slurmd
    

